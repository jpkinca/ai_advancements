# AI Trading Database Schema Documentation

## Overview

The AI Trading database schema extends the existing PostgreSQL database with a dedicated `ai_trading` schema that contains 12 core tables designed to support AI-driven trading operations. This schema provides comprehensive tracking of AI models, training sessions, trading signals, performance metrics, and analytical results.

---

## Database Architecture

### Schema Organization
- **Primary Schema**: `ai_trading` - Logical separation from existing trading operations
- **Integration**: Views and foreign keys connect AI data with existing market data
- **Deployment**: Compatible with Railway PostgreSQL deployment

---

## Core Tables Documentation

### 1. `ai_models` - AI Model Registry

**Purpose**: Central registry for all AI trading models with their configurations and metadata.

| Field | Type | Purpose |
|-------|------|---------|
| `model_id` | UUID (PK) | Unique identifier for each AI model |
| `model_name` | VARCHAR(100) | Human-readable model name |
| `model_type` | VARCHAR(50) | Primary category: 'reinforcement_learning', 'genetic_optimization', 'sparse_spectrum' |
| `model_subtype` | VARCHAR(50) | Specific implementation: 'ppo', 'fourier', 'wavelet', etc. |
| `version` | VARCHAR(20) | Model version for tracking updates |
| `description` | TEXT | Detailed model description and purpose |
| `configuration` | JSONB | Model hyperparameters and settings |
| `performance_metrics` | JSONB | Latest performance summary |
| `is_active` | BOOLEAN | Whether model is currently in use |
| `created_at` | TIMESTAMPTZ | Model registration timestamp |
| `updated_at` | TIMESTAMPTZ | Last modification timestamp |

**Usage Example**:
```json
{
  "model_name": "PPOTrader_v2",
  "model_type": "reinforcement_learning",
  "model_subtype": "ppo",
  "configuration": {
    "learning_rate": 0.0003,
    "gamma": 0.99,
    "epsilon": 0.2,
    "state_size": 10,
    "action_size": 3
  }
}
```

---

### 2. `training_sessions` - Training History Tracking

**Purpose**: Track all model training runs with detailed metrics and artifacts.

| Field | Type | Purpose |
|-------|------|---------|
| `session_id` | UUID (PK) | Unique training session identifier |
| `model_id` | UUID (FK) | Reference to the model being trained |
| `session_name` | VARCHAR(100) | Descriptive session name |
| `start_time` | TIMESTAMPTZ | Training start timestamp |
| `end_time` | TIMESTAMPTZ | Training completion timestamp |
| `status` | VARCHAR(20) | 'running', 'completed', 'failed', 'stopped' |
| `training_data_period` | DATERANGE | Time range of training data |
| `validation_data_period` | DATERANGE | Time range of validation data |
| `hyperparameters` | JSONB | Training-specific parameters |
| `training_metrics` | JSONB | Loss curves, rewards, convergence data |
| `final_performance` | JSONB | Final validation metrics |
| `model_artifacts_path` | TEXT | Path to saved model files |
| `error_message` | TEXT | Error details if training failed |

**Usage Example**:
```json
{
  "training_metrics": {
    "episode_rewards": [10.5, 15.2, 18.9, ...],
    "loss_values": [0.05, 0.04, 0.03, ...],
    "convergence_achieved": true
  },
  "final_performance": {
    "total_reward": 295.72,
    "sharpe_ratio": 1.85,
    "max_drawdown": 0.12
  }
}
```

---

### 3. `ai_signals` - Trading Signal Generation

**Purpose**: Store all trading signals generated by AI models with confidence scores and targets.

| Field | Type | Purpose |
|-------|------|---------|
| `signal_id` | UUID (PK) | Unique signal identifier |
| `model_id` | UUID (FK) | Model that generated the signal |
| `symbol` | VARCHAR(20) | Trading symbol (AAPL, GOOGL, etc.) |
| `signal_type` | VARCHAR(10) | 'BUY', 'SELL', 'HOLD' |
| `confidence` | DECIMAL(5,4) | Model confidence (0.0-1.0) |
| `price_target` | DECIMAL(15,6) | Target price for the signal |
| `stop_loss` | DECIMAL(15,6) | Recommended stop loss level |
| `take_profit` | DECIMAL(15,6) | Recommended take profit level |
| `signal_timestamp` | TIMESTAMPTZ | When signal was generated |
| `market_data_timestamp` | TIMESTAMPTZ | Timestamp of underlying market data |
| `metadata` | JSONB | Model-specific signal details |

**Indexes for Performance**:
- `idx_ai_signals_symbol_time`: Fast queries by symbol and time
- `idx_ai_signals_model_time`: Model-specific signal history
- `idx_ai_signals_type_confidence`: Signal filtering by type and confidence

---

### 4. `signal_performance` - Signal Quality Tracking

**Purpose**: Track the actual performance of generated signals for model validation.

| Field | Type | Purpose |
|-------|------|---------|
| `performance_id` | UUID (PK) | Unique performance record identifier |
| `signal_id` | UUID (FK) | Reference to the original signal |
| `evaluation_timestamp` | TIMESTAMPTZ | When performance was evaluated |
| `actual_price` | DECIMAL(15,6) | Actual market price at evaluation |
| `price_change_pct` | DECIMAL(8,4) | Percentage change from signal time |
| `target_hit` | BOOLEAN | Whether price target was reached |
| `stop_loss_hit` | BOOLEAN | Whether stop loss was triggered |
| `holding_period_hours` | INTEGER | Duration signal was relevant |
| `pnl_if_executed` | DECIMAL(15,6) | Theoretical profit/loss |

**Business Value**: Enables continuous model validation and performance improvement.

---

### 5. `feature_data` - Machine Learning Features

**Purpose**: Store extracted features used by ML models for training and prediction.

| Field | Type | Purpose |
|-------|------|---------|
| `feature_id` | UUID (PK) | Unique feature record identifier |
| `symbol` | VARCHAR(20) | Asset symbol |
| `timestamp` | TIMESTAMPTZ | Feature extraction timestamp |
| `feature_set_name` | VARCHAR(50) | Type: 'technical_indicators', 'fourier_coefficients' |
| `features` | JSONB | Feature vector as JSON array |
| `raw_data_hash` | VARCHAR(64) | Hash for data versioning |
| `extraction_method` | VARCHAR(50) | Method used for feature extraction |

**Feature Examples**:
```json
{
  "feature_set_name": "technical_indicators",
  "features": {
    "sma_20": 150.25,
    "rsi_14": 65.8,
    "bollinger_upper": 155.0,
    "bollinger_lower": 145.0,
    "volume_ratio": 1.25
  }
}
```

---

### 6. `optimization_runs` - Genetic Algorithm Results

**Purpose**: Track genetic algorithm optimization sessions and results.

| Field | Type | Purpose |
|-------|------|---------|
| `run_id` | UUID (PK) | Unique optimization run identifier |
| `model_id` | UUID (FK) | Associated model |
| `optimization_type` | VARCHAR(50) | 'parameter_optimization', 'portfolio_optimization' |
| `objective_function` | VARCHAR(50) | 'sharpe_ratio', 'total_return', 'max_drawdown' |
| `population_size` | INTEGER | GA population size |
| `generations` | INTEGER | Number of generations |
| `parameter_ranges` | JSONB | Search space definition |
| `best_individual` | JSONB | Optimal solution found |
| `best_fitness` | DECIMAL(15,6) | Best fitness score achieved |
| `convergence_data` | JSONB | Fitness evolution over time |
| `final_population` | JSONB | Final population state |

---

### 7. `optimization_individuals` - Individual GA Solutions

**Purpose**: Store individual solutions from genetic algorithm runs for analysis.

| Field | Type | Purpose |
|-------|------|---------|
| `individual_id` | UUID (PK) | Unique individual identifier |
| `run_id` | UUID (FK) | Reference to optimization run |
| `generation` | INTEGER | Generation number |
| `individual_rank` | INTEGER | Rank within generation |
| `genes` | JSONB | Parameter values (chromosome) |
| `fitness_score` | DECIMAL(15,6) | Individual fitness score |
| `objectives` | JSONB | Multi-objective scores |

**Example Genes**:
```json
{
  "genes": {
    "sma_short": 12,
    "sma_long": 31,
    "rsi_period": 20,
    "rsi_oversold": 31,
    "rsi_overbought": 73
  },
  "fitness_score": 2.5075
}
```

---

### 8. `anomaly_detections` - Market Anomaly Detection

**Purpose**: Track anomalies detected by AI models for risk management.

| Field | Type | Purpose |
|-------|------|---------|
| `anomaly_id` | UUID (PK) | Unique anomaly identifier |
| `model_id` | UUID (FK) | Model that detected the anomaly |
| `symbol` | VARCHAR(20) | Affected symbol |
| `detection_timestamp` | TIMESTAMPTZ | When anomaly was detected |
| `anomaly_type` | VARCHAR(50) | 'price_jump', 'volume_spike', 'pattern_break' |
| `severity_score` | DECIMAL(8,4) | Severity (standard deviations from normal) |
| `confidence` | DECIMAL(5,4) | Detection confidence |
| `market_data_context` | JSONB | Relevant market conditions |
| `anomaly_details` | JSONB | Model-specific anomaly data |
| `resolved` | BOOLEAN | Whether anomaly has been resolved |

**Risk Management Value**: Enables proactive risk management and model adaptation.

---

### 9. `model_performance` - Performance Metrics Over Time

**Purpose**: Track model performance metrics across different time periods.

| Field | Type | Purpose |
|-------|------|---------|
| `performance_id` | UUID (PK) | Unique performance record |
| `model_id` | UUID (FK) | Reference to model |
| `evaluation_period` | DATERANGE | Time period evaluated |
| `total_signals` | INTEGER | Number of signals generated |
| `successful_signals` | INTEGER | Number of successful signals |
| `signal_accuracy` | DECIMAL(5,4) | Percentage of correct signals |
| `avg_confidence` | DECIMAL(5,4) | Average model confidence |
| `sharpe_ratio` | DECIMAL(8,4) | Risk-adjusted return metric |
| `max_drawdown` | DECIMAL(8,4) | Maximum portfolio decline |
| `total_return` | DECIMAL(8,4) | Total return for period |
| `volatility` | DECIMAL(8,4) | Return volatility |
| `win_rate` | DECIMAL(5,4) | Percentage of profitable trades |
| `avg_holding_period_hours` | DECIMAL(8,2) | Average trade duration |

---

### 10. `rl_episodes` - Reinforcement Learning Training Data

**Purpose**: Store detailed reinforcement learning episode data for training analysis.

| Field | Type | Purpose |
|-------|------|---------|
| `episode_id` | UUID (PK) | Unique episode identifier |
| `session_id` | UUID (FK) | Training session reference |
| `episode_number` | INTEGER | Episode sequence number |
| `total_reward` | DECIMAL(15,6) | Cumulative episode reward |
| `episode_length` | INTEGER | Number of steps taken |
| `final_portfolio_value` | DECIMAL(15,6) | End portfolio value |
| `max_drawdown` | DECIMAL(8,4) | Maximum drawdown during episode |
| `actions_taken` | JSONB | Sequence of actions |
| `rewards` | JSONB | Reward sequence |
| `episode_end_reason` | VARCHAR(50) | How episode ended |

---

### 11. `spectrum_analysis` - Frequency Domain Analysis

**Purpose**: Store results from Fourier and wavelet analysis for pattern recognition.

| Field | Type | Purpose |
|-------|------|---------|
| `analysis_id` | UUID (PK) | Unique analysis identifier |
| `model_id` | UUID (FK) | Model that performed analysis |
| `symbol` | VARCHAR(20) | Analyzed symbol |
| `analysis_timestamp` | TIMESTAMPTZ | Analysis timestamp |
| `analysis_type` | VARCHAR(50) | 'fourier', 'wavelet', 'compressed_sensing' |
| `frequency_components` | JSONB | Dominant frequencies found |
| `spectral_features` | JSONB | Extracted spectral features |
| `pattern_detected` | VARCHAR(100) | Named pattern if identified |
| `pattern_confidence` | DECIMAL(5,4) | Pattern detection confidence |
| `reconstruction_error` | DECIMAL(15,10) | Reconstruction quality metric |

**Example Frequency Components**:
```json
{
  "dominant_frequencies": [0.05, 0.12, 0.25],
  "amplitudes": [15.2, 8.7, 5.1],
  "phases": [0.2, 1.1, 2.8],
  "significance_scores": [0.95, 0.87, 0.72]
}
```

---

## Integration Views

### `enriched_ai_signals`
Combines AI signals with performance data for comprehensive analysis:
- Signal details with model information
- Performance tracking data
- Market context integration

### `latest_model_performance`
Provides most recent performance metrics for all active models:
- Latest performance snapshot per model
- Active model filtering
- Key performance indicators

---

## Performance Optimizations

### Indexing Strategy
1. **Time-based queries**: Optimized for recent data access
2. **Symbol-specific queries**: Fast symbol filtering
3. **Model-specific queries**: Efficient model analysis
4. **Composite indexes**: Multi-column query optimization

### Data Retention
- **Feature data**: 90-day default retention with cleanup function
- **Training sessions**: Permanent retention for audit trail
- **Signal performance**: Historical tracking for model validation

---

## Business Intelligence Integration

### Key Metrics Tracked
1. **Model Performance**: Sharpe ratio, win rate, drawdown
2. **Signal Quality**: Accuracy, confidence correlation
3. **Training Efficiency**: Convergence rates, resource usage
4. **Anomaly Detection**: Risk event identification

### Reporting Capabilities
- Real-time model performance dashboards
- Historical signal analysis
- Training progress monitoring
- Anomaly alert systems

---

## Deployment and Maintenance

### Railway PostgreSQL Integration
- Schema designed for Railway deployment
- Environment variable configuration
- Automatic UUID generation
- JSONB for flexible data storage

### Maintenance Functions
- `cleanup_old_feature_data()`: Automated data retention
- `update_model_performance()`: Performance metric calculation
- Built-in data validation and constraints

---

## Conclusion

This database schema provides a comprehensive foundation for AI trading operations, enabling:
- **Model Lifecycle Management**: From training to production deployment
- **Performance Monitoring**: Continuous validation and improvement
- **Risk Management**: Anomaly detection and signal quality tracking
- **Business Intelligence**: Comprehensive reporting and analytics

The schema balances flexibility (JSONB fields) with performance (optimized indexes) while maintaining data integrity through foreign key constraints and validation rules.
